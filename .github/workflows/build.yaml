name: Build QEMU for Android ARM64

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-qemu-android:
    runs-on: ubuntu-latest
    env:
      API_LEVEL: 33
      TARGET: aarch64-linux-android

    steps:
      - name: Checkout QEMU source
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential git python3 pkg-config ninja-build wget unzip libglib2.0-dev

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip android-ndk-r26b-linux.zip
          echo "ANDROID_NDK=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Set up Android NDK cross toolchain
        run: |
          TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64
          echo "CC=$TOOLCHAIN/bin/$TARGET$API_LEVEL-clang" >> $GITHUB_ENV
          echo "CXX=$TOOLCHAIN/bin/$TARGET$API_LEVEL-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
          echo "LD=$TOOLCHAIN/bin/ld" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/bin/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/bin/llvm-strip" >> $GITHUB_ENV

      - name: Configure QEMU (wrapper around Meson)
        run: |
          cd $GITHUB_WORKSPACE
          ./configure \
            --prefix=$GITHUB_WORKSPACE/build-android \
            --target-list=aarch64-softmmu,arm-softmmu \
            --disable-tools
          # This internally sets up Meson + Ninja for cross-compilation
          # and avoids running sanity test executables on the host

      - name: Build QEMU
        run: |
          cd $GITHUB_WORKSPACE
          make -j$(nproc)
          make install

      - name: Upload QEMU binaries
        uses: actions/upload-artifact@v4
        with:
          name: qemu-android
          path: ${{ github.workspace }}/build-android/bin/