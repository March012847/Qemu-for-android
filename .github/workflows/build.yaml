name: Build QEMU for Android

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-qemu-android:
    runs-on: ubuntu-latest
    env:
      API_LEVEL: 33  # Android API level
      TARGET_AARCH64: aarch64-linux-android
      TARGET_ARM: arm-linux-androideabi

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential git python3 pkg-config ninja-build wget unzip libglib2.0-dev

      - name: Download Android NDK
        run: |
          wget https://dl.google.com/android/repository/android-ndk-r26b-linux.zip
          unzip android-ndk-r26b-linux.zip
          echo "ANDROID_NDK=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV

      - name: Set up cross-compilation toolchain
        run: |
          TOOLCHAIN=$ANDROID_NDK/toolchains/llvm/prebuilt/linux-x86_64
          echo "CC_AARCH64=$TOOLCHAIN/bin/$TARGET_AARCH64$API_LEVEL-clang" >> $GITHUB_ENV
          echo "CXX_AARCH64=$TOOLCHAIN/bin/$TARGET_AARCH64$API_LEVEL-clang++" >> $GITHUB_ENV
          echo "AR=$TOOLCHAIN/bin/llvm-ar" >> $GITHUB_ENV
          echo "LD=$TOOLCHAIN/bin/ld" >> $GITHUB_ENV
          echo "RANLIB=$TOOLCHAIN/bin/llvm-ranlib" >> $GITHUB_ENV
          echo "STRIP=$TOOLCHAIN/bin/llvm-strip" >> $GITHUB_ENV

      - name: Clone QEMU
        run: |
          git clone https://gitlab.com/qemu-project/qemu.git
          cd qemu
          git checkout stable-8.2
          echo "QEMU_DIR=$(pwd)" >> $GITHUB_ENV

      - name: Configure QEMU
        run: |
          cd $QEMU_DIR
          ./configure \
            --prefix=$QEMU_DIR/build-android \
            --target-list=aarch64-softmmu,arm-softmmu \
            --cc=$CC_AARCH64 \
            --cxx=$CXX_AARCH64 \
            --disable-tools

      - name: Build QEMU
        run: |
          cd $QEMU_DIR
          make -j$(nproc)
          make install

      - name: Upload QEMU binaries
        uses: actions/upload-artifact@v4
        with:
          name: qemu-android
          path: ${{ github.workspace }}/qemu/build-android/bin/