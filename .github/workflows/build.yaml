name: Build QEMU for Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-aarch64:
    name: Build QEMU for aarch64 Android
    runs-on: ubuntu-latest
    env:
      QEMU_VERSION: 7.2.21
      ANDROID_API: 21
      ANDROID_NDK_VERSION: r25c
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install pkg-config
        run: sudo apt-get update && sudo apt-get install -y pkg-config

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      - name: Download QEMU source
        run: |
          wget https://download.qemu.org/qemu-${{ env.QEMU_VERSION }}.tar.xz
          tar xf qemu-${{ env.QEMU_VERSION }}.tar.xz

      - name: Verify clang exists
        run: |
          ls -l ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang

      - name: Configure for Android aarch64
        run: |
          cd qemu-${{ env.QEMU_VERSION }}
          mkdir -p build && cd build
          PKG_CONFIG=$(which pkg-config) ../configure \
            --target-list=aarch64-softmmu,aarch64-linux-user \
            --cross-prefix=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}- \
            --cc=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang \
            --cxx=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android${ANDROID_API}-clang++ \
            --extra-cflags="-fPIE -D__ANDROID_API__=${ANDROID_API}" \
            --extra-ldflags="-pie" \
            --disable-sdl --disable-gtk --disable-vnc \
            --disable-xen --disable-linux-aio

      - name: Build
        run: |
          cd qemu-${{ env.QEMU_VERSION }}/build
          make -j$(nproc)

      - name: Upload aarch64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: qemu-aarch64-android
          path: |
            qemu-${{ env.QEMU_VERSION }}/build/qemu-system-aarch64
            qemu-${{ env.QEMU_VERSION }}/build/qemu-aarch64

  build-x86_64:
    name: Build QEMU for x86_64 Android
    runs-on: ubuntu-latest
    env:
      QEMU_VERSION: 7.2.21
      ANDROID_API: 21
      ANDROID_NDK_VERSION: r25c
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install pkg-config
        run: sudo apt-get update && sudo apt-get install -y pkg-config

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      - name: Download QEMU source
        run: |
          wget https://download.qemu.org/qemu-${{ env.QEMU_VERSION }}.tar.xz
          tar xf qemu-${{ env.QEMU_VERSION }}.tar.xz

      - name: Verify clang exists
        run: |
          ls -l ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${ANDROID_API}-clang

      - name: Configure for Android x86_64
        run: |
          cd qemu-${{ env.QEMU_VERSION }}
          mkdir -p build && cd build
          PKG_CONFIG=$(which pkg-config) ../configure \
            --target-list=x86_64-softmmu,x86_64-linux-user \
            --cross-prefix=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${ANDROID_API}- \
            --cc=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${ANDROID_API}-clang \
            --cxx=${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android${ANDROID_API}-clang++ \
            --extra-cflags="-fPIE -D__ANDROID_API__=${ANDROID_API}" \
            --extra-ldflags="-pie" \
            --disable-sdl --disable-gtk --disable-vnc \
            --disable-linux-aio

      - name: Build
        run: |
          cd qemu-${{ env.QEMU_VERSION }}/build
          make -j$(nproc)

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: qemu-x86_64-android
          path: |
            qemu-${{ env.QEMU_VERSION }}/build/qemu-system-x86_64
            qemu-${{ env.QEMU_VERSION }}/build/qemu-x86_64